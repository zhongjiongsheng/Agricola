<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†œåœºä¸» v3.0 - å¯ç¼–è¾‘æ€ç»´å¯¼å›¾</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #263238;
            font-family: 'Segoe UI', "Microsoft YaHei", sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            height: 50px;
            background: #37474f;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            justify-content: space-between;
            z-index: 10;
        }
        .toolbar h1 { margin: 0; font-size: 18px; color: #ffd700; margin-right: 20px; }
        .btn-group { display: flex; gap: 10px; }
        
        button {
            background: #546e7a; color: white; border: 1px solid #78909c;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        button:hover { background: #78909c; border-color: #fff; }
        button.primary { background: #2e7d32; border-color: #43a047; }
        button.primary:hover { background: #43a047; }
        
        /* ä¸»ä½“å¸ƒå±€ */
        .container {
            display: flex;
            flex: 1;
            height: calc(100% - 50px);
        }

        /* å·¦ä¾§ç¼–è¾‘å™¨ */
        .editor-pane {
            width: 30%;
            min-width: 300px;
            background: #1e2529;
            border-right: 1px solid #455a64;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }
        .editor-pane.hidden { width: 0; min-width: 0; overflow: hidden; }
        
        textarea {
            flex: 1;
            background: #1e2529;
            color: #cfd8dc;
            border: none;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }
        textarea:focus { background: #232b30; }

        /* å³ä¾§é¢„è§ˆ */
        .preview-pane {
            flex: 1;
            position: relative;
            background: #263238;
        }
        #mindmap { width: 100%; height: 100%; }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e2529; }
        ::-webkit-scrollbar-thumb { background: #546e7a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #78909c; }

        .tip { font-size: 12px; color: #90a4ae; padding: 5px 15px; background: #151a1d; border-bottom: 1px solid #333; }
    </style>
    
    <!-- å¼•å…¥ markmap åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.15.4/dist/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"></script>
</head>
<body>

    <div class="toolbar">
        <div style="display:flex; align-items:center;">
            <h1>ğŸŒ¾ å†œåœºä¸» v3.0 å¯¼å›¾ç¼–è¾‘å™¨</h1>
            <button onclick="toggleEditor()">ğŸ“ åˆ‡æ¢ç¼–è¾‘/é¢„è§ˆ</button>
        </div>
        <div class="btn-group">
            <button onclick="expandAll()">â• å±•å¼€å…¨éƒ¨</button>
            <button onclick="collapseAll()">â– æ”¶ç¼©å…¨éƒ¨</button>
            <button onclick="saveLocally()">ğŸ’¾ ä¿å­˜(æœ¬åœ°)</button>
            <button class="primary" onclick="exportHTML()">ğŸ“¤ å¯¼å‡ºHTMLæ–‡ä»¶</button>
        </div>
    </div>

    <div class="container">
        <div class="editor-pane" id="editorPane">
            <div class="tip">æç¤ºï¼šä½¿ç”¨ Tab ç¼©è¿›å¢åŠ å±‚çº§ï¼Œä½¿ç”¨ - å¼€å¤´åˆ›å»ºèŠ‚ç‚¹</div>
            <textarea id="source" spellcheck="false"></textarea>
        </div>
        <div class="preview-pane">
            <svg id="mindmap"></svg>
        </div>
    </div>

<script>
// 1. é»˜è®¤æ•°æ® (v3.0 æ ¸å¿ƒé€»è¾‘)
const DEFAULT_MARKDOWN = `# ğŸŒ¾ å†œåœºä¸» v3.0 æ ¸å¿ƒæœºåˆ¶

## 1. æ¸¸æˆå¾ªç¯ (Game Loop)
- **åˆå§‹åŒ–**
  - ç”Ÿæˆç©å®¶: 1 äººç±» + 3 AI
  - åˆ†å‘èµ„æº: 2 æœ¨å±‹, 2 å·¥äºº, åˆå§‹é£Ÿç‰©
  - ç‰Œå †: æ´—æ·· R1-R6 å›åˆå¡
- **å›åˆæµç¨‹ (14è½®)**
  - **1. èµ„æºç´¯ç§¯**: è¡ŒåŠ¨æ ¼è‡ªåŠ¨å¢åŠ  (å¦‚: æ£®æ—+3æœ¨)
  - **2. ç©å®¶è¡ŒåŠ¨**: è½®æµæ´¾é£å·¥äººï¼Œç›´åˆ°æ‰€æœ‰å·¥äººç”¨å°½
  - **3. å›åˆç»“æŸ**: å½’è¿˜å·¥äººï¼Œæ¸…ç†å ç”¨ï¼Œç¿»å¼€æ–°å¡
- **æ”¶è·é˜¶æ®µ (Harvest)**
  - è§¦å‘è½®æ¬¡: 4, 7, 9, 11, 13, 14
  - **A. å†œç”°**: ä½œç‰©ä»ç”°é‡Œç§»å…¥ä»“åº“
  - **B. å–‚å…»**: æ¶ˆè€—2é£Ÿç‰©/äºº (ä¸è¶³åˆ™æ‰£åˆ†/ä¹è®¨)
  - **C. ç¹æ®–**: åŒç§åŠ¨ç‰© >=2 ä¸”æœ‰çª -> +1åª

## 2. å†œåœºç®¡ç† (Farm Board)
- **åœ°å—ç³»ç»Ÿ**
  - **ç©ºåœ° (Empty)**: åˆå§‹çŠ¶æ€ (æ‰£åˆ†é¡¹)
  - **æˆ¿é—´ (Room)**: æœ¨->ç –->çŸ³ (æ¯é—´é™å…»1åªå® ç‰©)
  - **å†œç”° (Field)**: ç§æ¤å°éº¦/è”¬èœ
  - **é©¬å© (Stable)**: å¢åŠ åœˆåœ°å®¹é‡
- **æ …æ ç³»ç»Ÿ (Strict Rules)**
  - **å»ºé€ **: æ¶ˆè€—æœ¨å¤´ï¼Œç‚¹å‡»æ ¼è¾¹
  - **æ ¡éªŒ**: å¿…é¡»é—­åˆ (æ— æ–­å¤´è·¯)
  - **æ’ä»–æ€§**: **åœˆåœ°å†…åªèƒ½æ˜¯ç©ºåœ°æˆ–é©¬å©**
  - **åŠŸèƒ½**: å½¢æˆç‰§åœºï¼Œå¤§å¹…æå‡åŠ¨ç‰©å®¹çº³é‡

## 3. è¡ŒåŠ¨ç³»ç»Ÿ (Actions)
- **æ–°å¢è¡ŒåŠ¨ (v2.8)**
  - **å–è‰º**: 1é£Ÿç‰©(å¯ç´¯ç§¯)
  - **ä¸´æ—¶å·¥**: å›ºå®š 2 é£Ÿç‰©
- **æ ¸å¿ƒè¡ŒåŠ¨**
  - **èµ„æº**: æ£®æ—(æœ¨), ç²˜åœŸå‘, èŠ¦è‹‡, é‡‡çŸ³
  - **å†œä¸š**: æ‹¿ç§å­, çŠåœ°, **è‡ªç”±æ’­ç§** (æ”¯æŒå¤šç”°)
  - **å»ºç­‘**: **è‡ªç”±å»ºé€ ** (ä¸€æ¬¡æ€§é€ å¤šæˆ¿/å¤šé©¬å©)
- **è¿é”æœºåˆ¶ (Chain)**
  - **æ’­ç§ -> çƒ¤é¢åŒ…**: æ’­ç§ç¡®è®¤åï¼Œè‹¥æœ‰è®¾å¤‡å¯ç«‹å³æŠŠéº¦è½¬é¥­
  - **ç”Ÿå¨ƒ -> æ‰“å¡**: (æš‚ç”¨ä¹°å¡ä»£æ›¿)

## 4. AI ç­–ç•¥å¢å¼º (Smart AI)
- **ç”Ÿå­˜ä¼˜å…ˆ (Survival)**
  - ç›‘æµ‹è·ç¦»æ”¶è·çš„è½®æ•°
  - è‹¥é£Ÿç‰©æç¼ºï¼Œæœ€é«˜ä¼˜å…ˆçº§æŠ¢: é’“é±¼/å–è‰º/ä¸´æ—¶å·¥
- **äººå£é©±åŠ¨ (Growth)**
  - è‹¥ **æˆ¿é—´ > äººå£**: å¿…æŠ¢ç”Ÿäºº
  - è‹¥ **æˆ¿é—´ <= äººå£**: å¿…æŠ¢æœ¨/è‹‡ -> é€ æˆ¿
- **èµ„æºæƒè¡¡**
  - ä¼˜å…ˆæŠ¢å¤ºç´¯ç§¯æ•°é‡å¤šçš„èµ„æºæ ¼ (å¦‚ 6æœ¨ > 2æœ¨)
  - å»ºé€ /æ’­ç§æ—¶é‡‡ç”¨è´ªå©ªç®—æ³• (èƒ½é€ å¤šå°‘é€ å¤šå°‘)

## 5. è®¡åˆ†è§„åˆ™ (Real-time Score)
- **åŠ åˆ†é¡¹ (+)**
  - **ç”°åœ°/ç‰§åœº**: æ•°é‡è®¡åˆ†
  - **ä½œç‰©**: éº¦/èœ æ•°é‡
  - **åŠ¨ç‰©**: ç¾Š/çŒª/ç‰› æ•°é‡
  - **å»ºç­‘**: æˆ¿ç­‰çº§ * æˆ¿æ•°é‡
  - **äººå£**: 3åˆ† / äºº
  - **å‘å±•å¡**: å¡é¢åˆ† + åŠ åˆ†å¡
- **æ‰£åˆ†é¡¹ (-)**
  - **ç©ºåœ°**: æœªè¢«åˆ©ç”¨ä¸”æœªè¢«å›´ä½çš„æ ¼å­ (-1åˆ†/æ ¼)
  - **ä¹è®¨**: -3åˆ† / å¼ 
`;

// å…¨å±€å˜é‡
let mm; // markmap å®ä¾‹
let transformer; // è½¬æ¢å™¨
const editor = document.getElementById('source');
const svgEl = document.getElementById('mindmap');

// 2. åˆå§‹åŒ–é€»è¾‘
function init() {
    // å°è¯•ä» LocalStorage è¯»å–ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤
    const savedData = localStorage.getItem('agricola_mindmap_v3');
    editor.value = savedData ? savedData : DEFAULT_MARKDOWN;

    // åˆå§‹åŒ– Markmap å¯¹è±¡
    const { Transformer } = window.markmap;
    const { Markmap, loadCSS, loadJS } = window.markmap;
    
    transformer = new Transformer();
    
    // åˆ›å»ºå®ä¾‹
    mm = Markmap.create(svgEl, {
        autoFit: true,
        fitRatio: 0.95,
        duration: 500,
        style: id => {
            return { color: '#cccccc' } // é»˜è®¤æ–‡å­—é¢œè‰²
        }
    });

    // ç»‘å®šç¼–è¾‘å™¨è¾“å…¥äº‹ä»¶
    editor.addEventListener('input', updateMap);
    
    // é¦–æ¬¡æ¸²æŸ“
    updateMap();
}

// 3. æ ¸å¿ƒï¼šæ›´æ–°å¯¼å›¾
function updateMap() {
    const content = editor.value;
    const { root } = transformer.transform(content);
    mm.setData(root);
    mm.fit();
    
    // ç®€å•çš„é˜²æŠ–è‡ªåŠ¨ä¿å­˜
    clearTimeout(window.saveTimer);
    window.saveTimer = setTimeout(() => {
        localStorage.setItem('agricola_mindmap_v3', content);
    }, 1000);
}

// 4. åŠŸèƒ½ï¼šå±•å¼€å…¨éƒ¨
function expandAll() {
    // é‡æ–°è½¬æ¢æ•°æ®ï¼Œå¹¶è®¾ç½®æ‰€æœ‰èŠ‚ç‚¹ä¸ºå±•å¼€
    const { root } = transformer.transform(editor.value);
    
    // é€’å½’è®¾ç½® fold = false (ä¸æŠ˜å )
    const walk = (node) => {
        node.payload = { ...node.payload, fold: false };
        if (node.children) node.children.forEach(walk);
    };
    walk(root);
    
    mm.setData(root);
    mm.fit();
}

// 5. åŠŸèƒ½ï¼šæ”¶ç¼©å…¨éƒ¨ (åªä¿ç•™æ ¹èŠ‚ç‚¹å’Œç¬¬ä¸€å±‚)
function collapseAll() {
    const { root } = transformer.transform(editor.value);
    
    const walk = (node, depth) => {
        if (depth >= 1) { // æ”¶ç¼©ç¬¬2å±‚åŠä»¥ä¸‹
            node.payload = { ...node.payload, fold: true };
        } else {
            node.payload = { ...node.payload, fold: false };
        }
        if (node.children) node.children.forEach(c => walk(c, depth + 1));
    };
    walk(root, 0);
    
    mm.setData(root);
    mm.fit();
}

// 6. åŠŸèƒ½ï¼šåˆ‡æ¢ç¼–è¾‘å™¨æ˜¾ç¤º/éšè—
function toggleEditor() {
    const pane = document.getElementById('editorPane');
    pane.classList.toggle('hidden');
    // åŠ¨ç”»ç»“æŸåè°ƒæ•´å¯¼å›¾å¤§å°
    setTimeout(() => mm.fit(), 350);
}

// 7. åŠŸèƒ½ï¼šæ‰‹åŠ¨ä¿å­˜
function saveLocally() {
    localStorage.setItem('agricola_mindmap_v3', editor.value);
    alert('âœ… å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ç¼“å­˜');
}

// 8. åŠŸèƒ½ï¼šå¯¼å‡º HTML
function exportHTML() {
    const currentContent = editor.value;
    // è·å–å½“å‰é¡µé¢çš„ HTML ç»“æ„
    let html = document.documentElement.outerHTML;
    
    // æˆ‘ä»¬éœ€è¦æ›¿æ¢æ‰ textarea é‡Œçš„å†…å®¹ä¸ºå½“å‰æœ€æ–°å†…å®¹
    // ä¸ºäº†å®‰å…¨ï¼Œä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼Œæˆ–è€…é‡æ„ DOM
    // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„æŠ€å·§ï¼šå°†å½“å‰çš„ DEFAULT_MARKDOWN å˜é‡æ›¿æ¢æ‰
    // æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥æ„é€ ä¸€ä¸ªæ–°çš„ç®€å• HTML æ–‡ä»¶ï¼ŒåªåŒ…å«æŸ¥çœ‹å™¨
    
    const exportContent = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å†œåœºä¸» v3.0 å¯¼å›¾å¯¼å‡º</title>
<style>
body,html{margin:0;height:100%;background:#263238;color:#fff;overflow:hidden;}
svg{width:100%;height:100%;}
</style>
<script src="https://cdn.jsdelivr.net/npm/d3@7"><\/script>
<script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15.4"><\/script>
<script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15.4/dist/browser/index.min.js"><\/script>
</head>
<body>
<svg id="mindmap"></svg>
<script>
const markdown = \`${currentContent.replace(/`/g, '\\`').replace(/\${/g, '\\${')}\`;
const { Transformer } = window.markmap;
const { Markmap } = window.markmap;
const transformer = new Transformer();
const { root } = transformer.transform(markdown);
Markmap.create('#mindmap', { autoFit: true, style: id => ({color:'#ccc'}) }, root);
<\/script>
</body>
</html>`;

    const blob = new Blob([exportContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Agricola_Mindmap.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// å¯åŠ¨
init();

</script>
</body>
</html>